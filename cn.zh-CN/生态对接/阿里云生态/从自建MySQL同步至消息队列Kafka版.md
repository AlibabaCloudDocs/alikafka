# 从自建MySQL同步至消息队列Kafka版

通过数据传输服务DTS（Data Transmission Service），您可以将自建MySQL同步至消息队列Kafka版，扩展消息处理能力。

您已完成以下操作：

-   自建MySQL数据库且数据库版本为5.1、5.5、5.6、5.7或8.0版本。
-   购买并部署消息队列Kafka版。详情请参见[购买并部署实例](/cn.zh-CN/快速入门/步骤二：购买和部署实例/VPC接入.md)。

    **说明：** 消息队列Kafka版提供标准版和专业版，两种规格都支持数据同步。您可以根据自建Kafka集群迁移情况选择实例规格，详情请参见[评估规格](/cn.zh-CN/用户指南/迁移/评估规格.md)。

-   在目标实例中创建用于接收同步数据的Topic。详情请参见[创建Topic](https://help.aliyun.com/document_detail/99952.html#title-7lc-gsy-p0n)。

    **说明：**

    -   Topic名称只能包含字母、数字、下划线（\_）和短划线（-）。
    -   Topic名称长度限制在3~64字符，长度超过64字符将被自动截取。
    -   Topic名称创建后，将无法修改。

[消息队列Kafka版](https://help.aliyun.com/document_detail/68151.html)是阿里云提供的分布式、高吞吐、可扩展的消息队列服务，针对开源的Apache Kafka提供全托管服务，彻底解决开源产品长期以来的痛点，您只需专注于业务开发，无需部署运维。消息队列Kafka版广泛用于日志收集、监控数据聚合、流式数据处理、在线和离线分析等大数据领域，已成为大数据生态中不可或缺的部分。

## 注意事项

-   DTS在执行全量数据初始化时将占用源库和目标库一定的读写资源，可能会导致数据库的负载上升，在数据库性能较差、规格较低或业务量较大的情况下（例如源库有大量慢SQL、存在无主键表或目标库存在死锁等），可能会加重数据库压力，甚至导致数据库服务不可用。因此您需要在执行数据同步前评估源库和目标库的性能，同时建议您在业务低峰期执行数据同步（例如源库和目标库的CPU负载在30%以下）。
-   如果源数据库没有主键或唯一约束，且所有字段没有唯一性，可能会导致目标数据库中出现重复数据。

## 功能限制

-   同步对象仅支持数据表，不支持非数据表的对象。
-   不支持自动调整同步对象，如果对同步对象中的数据表进行重命名操作，且重命名后的名称不在同步对象中，那么这部分数据将不再同步到目标消息队列Kafka版集群中。如需将修改后的数据表继续数据同步至目标消息队列Kafka版集群中，您需要进行**修改同步对象**操作，详情请参见[新增同步对象](/cn.zh-CN/数据同步/同步作业管理/新增同步对象.md)。

## 支持同步的SQL操作

数据传输服务DTS支持同步的SQL操作包括INSERT、UPDATE、DELETE、REPLACE。

## 消息格式

同步到消息队列Kafka版集群中的数据以avro格式存储，schema定义详情请参见[DTS avro schema定义](https://github.com/LioRoger/subscribe_example/tree/master/avro)。

**说明：** 数据同步到消息队列Kafka版集群后，您需要根据avro schema定义进行数据解析。

## 费用说明

数据传输服务DTS费用，请参见[产品定价](https://help.aliyun.com/document_detail/117780.html#concept-261679)。

## 准备工作

[为自建MySQL创建账号并设置binlog](/cn.zh-CN/准备工作/为自建MySQL创建账号并设置binlog.md)

## 操作步骤

1.  购买数据同步作业，详情请参见[购买流程](/cn.zh-CN/快速入门/购买流程.md)。

    **说明：** 购买时，选择源实例为**MySQL**，目标实例为**Kafka**，选择同步拓扑为**单向同步**。

2.  登录[数据传输控制台](https://dts.console.aliyun.com/)。

3.  在左侧导航栏，单击**数据同步**。

4.  在同步作业列表页面顶部，选择同步的目标实例所属地域。

    ![选择地域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7349459951/p50604.png)

5.  定位至已购买的数据同步实例，单击**配置同步链路**。

6.  配置同步作业的源实例及目标实例信息。

    ![配置源和目标实例信息](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5720649951/p75455.png)

    |项目|选项|说明|
    |:-|:-|:-|
    |同步作业名称|无|DTS会自动生成一个同步作业名称，建议配置具有业务意义的名称（无唯一性要求），便于后续识别。|
    |源实例信息|实例类型|根据源库部署位置，您可以选择**RDS实例**、**ECS上的自建数据库**或**通过专线、VPN网关、智能网关接入的自建数据库**。 本文以**ECS上的自建数据库**为例介绍配置流程，其他类型的配置流程与该案例类似。 |
    |实例地区|购买数据同步实例时选择的源实例地域信息，不可变更。|
    |ECS实例ID|选择自建MySQL所属的ECS实例ID。|
    |数据库类型|固定为**MySQL**，不可变更。|
    |端口|填入自建MySQL的数据库服务端口。|
    |数据库账号|填入自建MySQL的数据库账号，该账号需具备REPLICATION SLAVE、REPLICATION CLIENT及所有同步对象的SELECT权限。|
    |数据库密码|填入该数据库账号对应的密码。|
    |目标实例信息|实例类型|选择**通过专线/VPN网关/智能网关接入的自建数据库**。 **说明：** 由于DTS暂时不支持直接选择消息队列Kafka版，此处将其作为自建Kafka来配置数据同步。 |
    |实例地区|购买数据同步实例时选择的目标实例地域信息，不可变更。|
    |对端专有网络|选择目标消息队列Kafka版实例所属的专有网络ID。您可以在消息队列Kafka版实例的**基本信息**页面中查看到专有网络ID。![basicinfo](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5720649951/p74095.png) |
    |数据库类型|选择为**Kafka**。|
    |IP地址|填入消息队列Kafka版实例**默认接入点**中的任意一个IP地址。 **说明：** 您可以在消息队列Kafka版实例的**基本信息**页面中，获取**默认接入点**对应的IP地址。 |
    |端口|消息队列Kafka版实例的服务端口，默认为9092。|
    |数据库账号|填入消息队列Kafka版实例的用户名。 **说明：** 如果消息队列Kafka版实例的实例类型为**VPC实例**，无需配置**数据库账号**和**数据库密码**。 |
    |数据库密码|填入该用户名对应的密码。|
    |Topic|    1.  单击右侧的**获取Topic列表**。
    2.  下拉选择具体的Topic名称。 |
    |Kafka版本|根据消息队列Kafka版实例版本，选择对应的版本信息。|

7.  单击页面右下角的**授权白名单并进入下一步**。

8.  配置同步对象信息。

    ![配置同步对象](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1738816951/p74146.png)

    |配置|说明|
    |:-|:-|
    |同步对象|在源库对象区域框中，选择需要同步的对象（仅支持选择数据表），然后单击![向右箭头](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8502659951/p40698.png)将其移动到已选对象区域框中。 **说明：** DTS会自动将表名映射为配置同步的源和目标实例信息时选择的Topic名称。如果需要更换同步的目标Topic（更换后的Topic需是消息队列Kafka版实例中真实存在的），您可以将鼠标指针放置在要进行名称映射的表上，并单击出现的**编辑**进行调整。 |

9.  上述配置完成后，单击页面右下角的**下一步**。

10. 配置同步初始化的高级配置信息。

    ![数据同步高级设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9130649951/p41055.png)

    **说明：** 同步初始化类型细分为：结构初始化，全量数据初始化。选中**结构初始化**和**全量数据初始化**后，DTS会在增量数据同步之前，将源数据库中待同步对象的结构和存量数据，同步到目标数据库。

11. 上述配置完成后，单击页面右下角的**预检查并启动**。

    **说明：**

    -   在数据同步作业正式启动之前，会先进行预检查。只有预检查通过后，才能成功启动数据同步作业。
    -   如果预检查失败，单击具体检查项后的![提示](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8502659951/p47468.png)图标，查看失败详情。根据提示修复后，重新进行预检查。
12. 在预检查对话框中显示**预检查通过**后，关闭预检查对话框，同步作业将正式开始。

13. 等待同步作业的链路初始化完成，直至处于**同步中**状态。

    您可以在数据同步页面，查看数据同步作业的状态。

    ![查看同步作业状态](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1349459951/p41059.png)


